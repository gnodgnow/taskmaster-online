<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Cloud</title>
    <!-- NEW: å¼•å…¥ Supabase JS å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [æ‚¨çš„ CSS æ ·å¼ä¿æŒä¸å˜] */
        :root {
            --color-primary: #00999F;       /* ä¸»è‰²è°ƒ - é’è‰² */
            --color-primary-dark: #007f85;
            --color-accent: #FEEE30;        /* å¼ºè°ƒè‰² - é»„è‰² */
            --color-secondary-blue: #81D2E3;/* è¾…åŠ©è‰² - å¤©è“ */
            --color-bg-mint: #BCEDD8;        /* è¾…åŠ©è‰² - è–„è·ç»¿ */
            --color-text-strong: #065758;    /* ä¸»æ–‡å­— - æ·±é’ */
            --color-background: #f8f9fa;
            --color-surface: #ffffff;
            --color-border: #e9ecef;
            --color-text-primary: var(--color-text-strong);
            --color-text-secondary: #6c757d;
            --color-success: #28a745;
            --color-danger: #e74c3c;
            --shadow-soft: 0 4px 15px rgba(6, 87, 88, 0.1);
            --border-radius: 8px;
        }
        html { font-size: 15px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Arial", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* NEW: è®¤è¯ç•Œé¢æ ·å¼ */
        #auth-container {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            text-align: center;
        }
        #auth-container h1 {
            color: var(--color-primary);
            margin-bottom: 1.5rem;
        }
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .auth-form input { margin-bottom: 0.5rem; }
        .auth-form button { width: 100%; }
        #auth-toggle {
            margin-top: 1rem;
            background: none;
            border: none;
            color: var(--color-primary);
            cursor: pointer;
            font-size: 0.9rem;
        }
        #auth-message { margin-top: 1rem; color: var(--color-danger); font-size: 0.9rem; }
        #app-loading { font-size: 1.5rem; color: var(--color-primary); }

        /* NEW: é»˜è®¤éšè—ä¸»åº”ç”¨ */
        .app-container { display: none; width: 100%; height: 100%; padding: 1.2rem; gap: 1.2rem; }
        
        /* [æ‚¨çš„å…¶ä»– CSS æ ·å¼...] */
        .sidebar { flex: 0 0 22rem; min-width: 280px; max-width: 350px; background-color: var(--color-surface); border-radius: var(--border-radius); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.2rem; box-shadow: var(--shadow-soft); overflow-y: auto; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--color-surface); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-soft); min-width: 0; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .sidebar-section { background-color: var(--color-background); border-radius: 10px; padding: 1rem; flex-shrink: 0; }
        .sidebar-section h3 { font-size: 0.9rem; margin-bottom: 0.8rem; font-weight: 600; color: var(--color-text-primary); }
        button { padding: 0.6rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s, opacity 0.2s; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
        .btn { background-color: #e9ecef; color: var(--color-text-primary); }
        .btn:hover:not(:disabled) { background-color: #dee2e6; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-dark); }
        .tabs { display: flex; border-bottom: 1px solid var(--color-border); padding: 0.5rem 1.5rem 0 1.5rem; flex-shrink: 0; }
        .tab-button { background-color: transparent; font-weight: 500; border-bottom: 3px solid transparent; color: var(--color-text-secondary); }
        .tab-button.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .tab-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .tab-pane { display: none; } .tab-pane.active { display: block; }
        input, select, textarea { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); border-radius: 8px; background-color: #fff; font-size: 0.9rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 153, 159, 0.2); }
        #add-task-form { display: grid; grid-template-columns: 2fr 1fr 1fr 1.5fr auto auto; gap: 1rem; align-items: end; margin-bottom: 1.2rem; }
        .task-list-container { height: calc(100% - 90px); overflow-y: auto; }
        #task-table { width: 100%; border-collapse: separate; border-spacing: 0 0.5rem; }
        #task-table thead th { text-align: left; padding: 0.6rem 1rem; color: var(--color-text-secondary); font-weight: 500; font-size: 0.8rem; border-bottom: 1px solid var(--color-border); }
        #task-table tbody tr { border-radius: var(--border-radius); transition: box-shadow 0.2s; }
        #task-table tbody tr:hover { box-shadow: 0 2px 8px rgba(6, 87, 88, 0.1); }
        #task-table tbody td { padding: 0.8rem 1rem; background-color: var(--color-surface); border-top: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); }
        #task-table tbody td:first-child { border-left: 1px solid var(--color-border); border-top-left-radius: var(--border-radius); border-bottom-left-radius: var(--border-radius); }
        #task-table tbody td:last-child { border-right: 1px solid var(--color-border); border-top-right-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); }
        .task-name { font-weight: 500; }
        .badge { padding: 3px 10px; border-radius: 16px; font-size: 0.75rem; font-weight: 500; display: inline-block; }
        .urgency-badge.urgency-4 { background-color: var(--color-accent); color: var(--color-text-strong); }
        .urgency-badge.urgency-3 { background-color: rgba(0, 153, 159, 0.15); color: var(--color-primary-dark); }
        .urgency-badge.urgency-2 { background-color: rgba(129, 210, 227, 0.25); color: #0f6270; }
        .urgency-badge.urgency-1 { background-color: var(--color-border); color: var(--color-text-secondary); }
        .status-badge.å·²å®Œæˆ { background-color: #e6f5f5; color: #006970; }
        .status-badge.è¿›è¡Œä¸­ { background-color: var(--color-primary); color: white; }
        .status-badge.å·²æš‚åœ { background-color: var(--color-border); color: var(--color-text-secondary); }
        .status-badge.å¾…åŠ { background-color: #f1f3f5; color: #495057; }
        .inline-edit { -webkit-appearance: none; appearance: none; border: none; background-color: transparent; font: inherit; }
        .stat-date-range { display: flex; flex-direction: column; gap: 0.6rem; margin-top: 0.5rem; }
        #stats-display { display: flex; justify-content: space-around; text-align: center; margin-top: 1rem; }
        .stat-number { font-size: 1.8rem; font-weight: 700; color: var(--color-primary); }
        .urgent-tasks-section { min-height: 150px; display: flex; flex-direction: column; }
        #urgent-tasks-list { list-style-type: none; padding: 0; }
        #urgent-tasks-list li { padding: 0.4rem 0.2rem; font-size: 0.85rem; border-bottom: 1px solid var(--color-border); }
        #urgent-tasks-list li:last-child { border-bottom: none; }
        #urgent-tasks-list li.urgency-4 { font-weight: 600; color: var(--color-primary-dark); }
        #urgent-tasks-list li.urgency-3 { color: var(--color-text-strong); }
        #urgent-tasks-list li.urgency-2 { color: var(--color-text-primary); }
        #urgent-tasks-list li small { display: block; color: var(--color-text-secondary); font-size: 0.75rem; margin-top: 2px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--color-surface); padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 6px 20px rgba(44, 62, 80, 0.1); width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-body { overflow-y: auto; padding-right: 1rem; }
        .modal-footer { margin-top: 1.5rem; text-align: right; }
        #edit-daily-progress-container { max-height: 200px; overflow-y: auto; background: var(--color-background); padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>
    <!-- NEW: åˆå§‹åŠ è½½/è®¤è¯ç•Œé¢ -->
    <div id="app-loading">æ­£åœ¨åŠ è½½åº”ç”¨...</div>

    <div id="auth-container" style="display: none;">
        <h1>æ¬¢è¿æ¥åˆ° TaskMaster</h1>
        <form class="auth-form" id="login-form">
            <input type="email" id="auth-email" placeholder="é‚®ç®±" required>
            <input type="password" id="auth-password" placeholder="å¯†ç " required>
            <button type="submit" class="btn-primary">ç™»å½•</button>
        </form>
         <form class="auth-form" id="signup-form" style="display: none;">
            <input type="email" id="signup-email" placeholder="é‚®ç®±" required>
            <input type="password" id="signup-password" placeholder="è®¾ç½®å¯†ç " required>
            <button type="submit" class="btn-primary">æ³¨å†Œ</button>
        </form>
        <div id="auth-message"></div>
        <button id="auth-toggle">è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿç‚¹æ­¤æ³¨å†Œ</button>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
             <!-- NEW: ç”¨æˆ·ä¿¡æ¯å’Œç™»å‡ºæŒ‰é’® -->
            <div class="sidebar-header sidebar-section">
                <div>
                    <h3 style="margin:0;">ä½ å¥½!</h3>
                    <span id="user-email" style="font-size: 0.8rem; color: var(--color-text-secondary);"></span>
                </div>
                <button id="logout-btn" class="btn" style="padding: 0.4rem 0.8rem;">ç™»å‡º</button>
            </div>
            <div class="sidebar-section"> <input type="text" id="search-box" placeholder="ğŸ” æœç´¢ä»»åŠ¡..."> </div>
            <div class="sidebar-section">
                <h3>æ’åºé€‰é¡¹</h3>
                <div style="display: flex; flex-direction: column; gap: 0.6rem;"> <button id="sort-urgency" class="btn">æŒ‰é‡è¦ç¨‹åº¦</button> <button id="sort-status" class="btn">æŒ‰ä»»åŠ¡çŠ¶æ€</button> <button id="clear-filter" class="btn-primary">æ¸…é™¤ç­›é€‰ä¸æ’åº</button> </div>
            </div>
            <div class="sidebar-section">
                <h3>ä»»åŠ¡ç»Ÿè®¡</h3>
                <div class="stat-date-range"> <label style="font-size:0.8rem; color:var(--color-text-secondary);">å¼€å§‹æ—¥æœŸ:</label> <input type="date" id="stats-start-date"> <label style="font-size:0.8rem; color:var(--color-text-secondary); margin-top:0.5rem;">ç»“æŸæ—¥æœŸ:</label> <input type="date" id="stats-end-date"> </div>
                <div id="stats-display"> <div class="stat-item"><div id="stat-total" class="stat-number">0</div><div class="stat-label">æ€»æ•°</div></div> <div class="stat-item"><div id="stat-completed" class="stat-number" style="color:var(--color-success)">0</div><div class="stat-label">å·²å®Œæˆ</div></div> <div class="stat-item"><div id="stat-pending" class="stat-number" style="color:var(--color-danger)">0</div><div class="stat-label">æœªå®Œæˆ</div></div> </div>
            </div>
            <div class="sidebar-section urgent-tasks-section">
                <h3>ç´§æ€¥ä»»åŠ¡æé†’ (è¿‘2å¤©)</h3>
                <div class="list-container"> <ul id="urgent-tasks-list"></ul> </div>
            </div>
            <div class="sidebar-section">
                <h3>æ•°æ®æ“ä½œ</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;"> <button id="backup-data" class="btn">å¤‡ä»½æ•°æ®åˆ°æœ¬åœ°</button> </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <nav class="tabs"> <button class="tab-button active" data-tab="tasks">ä»»åŠ¡åˆ—è¡¨</button> <button class="tab-button" data-tab="progress">æ¯å‘¨è¿›å±•</button> </nav>
            <div id="tab-tasks" class="tab-pane active tab-content">
                <form id="add-task-form"> <input type="text" id="task-name" placeholder="è¾“å…¥ä»»åŠ¡åç§°..." required> <input type="date" id="task-start-date" required> <input type="date" id="task-end-date" required> <select id="task-urgency" required></select> <button type="submit" class="btn-primary">æ·»åŠ </button> <button type="button" id="batch-op-btn" class="btn">æ‰¹é‡æ·»åŠ </button> </form>
                <div class="task-list-container">
                    <table id="task-table">
                        <thead><tr><th style="width: 5%;">#</th><th style="width: 40%;">ä»»åŠ¡åç§°</th><th style="width: 15%;">èµ·æ­¢æ—¥æœŸ</th><th style="width: 15%;">é‡è¦ç¨‹åº¦</th><th style="width: 15%;">çŠ¶æ€</th><th style="width: 10%;">æ“ä½œ</th></tr></thead>
                        <tbody id="task-list-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="tab-progress" class="tab-pane tab-content">
                <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap;"> <label for="week-selector">é€‰æ‹©å‘¨:</label> <select id="week-selector" style="width: 250px;"></select> <button id="generate-report-btn" class="btn-primary">åˆ·æ–°å‘¨æŠ¥</button> <button id="save-report-btn" class="btn">ä¿å­˜å‘¨æŠ¥</button> </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; height: calc(100% - 60px);">
                    <section style="background-color: var(--color-background); border-radius: 10px; padding: 1.5rem; display: flex; flex-direction: column; overflow: hidden;">
                        <h3>æœ¬å‘¨ç›¸å…³ä»»åŠ¡</h3>
                        <div id="weekly-plan-display" style="flex-grow: 1; overflow-y: auto; background-color: var(--color-surface); padding: 1rem; border-radius: 8px; white-space: pre-wrap; font-size: 0.9rem;"></div>
                    </section>
                    <section style="background-color: var(--color-background); border-radius: 10px; padding: 1.5rem; display: flex; flex-direction: column; overflow: hidden;">
                        <h3>å‘¨æŠ¥æ€»ç»“ (å¯ç¼–è¾‘)</h3>
                        <textarea id="generated-report-area" style="flex-grow: 1; resize: none; border: none; background-color: var(--color-surface); padding: 1rem; border-radius: 8px; font-size: 0.9rem;"></textarea>
                    </section>
                </div>
            </div>
        </main>
    </div>
    
    <!-- [æ‚¨çš„æ¨¡æ€æ¡† HTML ä¿æŒä¸å˜] -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>æ‰¹é‡æ·»åŠ ä»»åŠ¡</h2><button class="modal-close" data-target="batch-modal">Ã—</button></div>
            <div class="modal-body">
                <div id="batch-tasks-container"><div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;"><input type="text" class="batch-name" placeholder="ä»»åŠ¡åç§°"><input type="date" class="batch-start-date"><input type="date" class="batch-end-date"><select class="batch-urgency"></select></div></div>
                <button id="add-batch-row" class="btn" style="margin-top: 10px;">+ æ·»åŠ å¦ä¸€è¡Œ</button>
            </div>
            <div class="modal-footer"> <button class="btn modal-close" data-target="batch-modal">å–æ¶ˆ</button> <button id="save-batch-btn" class="btn-primary">ä¿å­˜ä»»åŠ¡</button> </div>
        </div>
    </div>
    <div id="edit-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header"><h2>ç¼–è¾‘ä»»åŠ¡</h2><button class="modal-close" data-target="edit-modal">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-task-id">
                <div style="border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; margin-bottom: 1rem;"> <h4>å½•å…¥ä»Šæ—¥è¿›å±•</h4> <div style="display: flex; gap: 10px; margin-top: 5px;"><input type="text" id="new-progress-content" placeholder="è¾“å…¥è¿›å±•å†…å®¹..." style="flex-grow: 1;"><button id="add-progress-btn" class="btn">æ·»åŠ </button></div> </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"> <div><label>ä»»åŠ¡åç§°</label><input type="text" id="edit-task-name"></div> <div><label>é‡è¦ç¨‹åº¦</label><select id="edit-task-urgency"></select></div> <div><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="edit-task-start-date"></div> <div><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="edit-task-end-date"></div> </div>
                <div style="margin-top: 15px;"><label>ä»»åŠ¡çŠ¶æ€</label><select id="edit-task-status"></select></div> <div style="margin-top: 15px;"><label>å¤‡æ³¨</label><textarea id="edit-task-notes" rows="3"></textarea></div>
                <div style="margin-top: 15px;"> <h4>å†å²è¿›å±•è®°å½•</h4> <div id="edit-daily-progress-container"></div> </div>
            </div>
            <div class="modal-footer"> <button class="btn modal-close" data-target="edit-modal">å–æ¶ˆ</button> <button id="save-edit-btn" class="btn-primary">ä¿å­˜æ›´æ”¹</button> </div>
        </div>
    </div>

<script>
// NEW: ä½¿ç”¨ DOMContentLoaded äº‹ä»¶ç¡®ä¿æ‰€æœ‰ HTML å…ƒç´ åŠ è½½å®Œæ¯•
document.addEventListener('DOMContentLoaded', () => {
    
    // NEW: Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–
    const SUPABASE_URL = 'https://oprqecajnzvzusjqqolk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9wcnFlY2Fqbnp2enVzanFxb2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTQzMzMsImV4cCI6MjA2OTU5MDMzM30.lY691Yw7u6ipUxXW6inYAnkv-ohJT96OWTAU-usMJOw';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- å®šä¹‰å¸¸é‡å’Œå…¨å±€å˜é‡ ---
    const URGENCY_LEVELS = {"éå¸¸é‡è¦ç´§æ€¥":{value:4},"é‡è¦ä¸ç´§æ€¥":{value:3},"ç´§æ€¥ä¸é‡è¦":{value:2},"ä¸é‡è¦ä¸ç´§æ€¥":{value:1}};
    const STATUS_OPTIONS = ["å¾…åŠ","è¿›è¡Œä¸­","å·²æš‚åœ","å·²å®Œæˆ"];
    const URGENT_REMINDER_DAYS = 2;
    // NEW: ä¸å†éœ€è¦ STORAGE_KEY
    let tasks = [];
    let weeklyProgress = {};
    let currentSort = { key: 'created_at', reverse: true }; // NEW: é»˜è®¤æŒ‰åˆ›å»ºæ—¶é—´é™åº
    let currentFilter = '';
    // NEW: ç”¨æˆ·çŠ¶æ€å˜é‡
    let currentUser = null;

    // --- DOM å…ƒç´ ç¼“å­˜ ---
    const taskListBody = document.getElementById('task-list-body');
    const searchBox = document.getElementById('search-box');
    const statsStartDateInput = document.getElementById('stats-start-date');
    const statsEndDateInput = document.getElementById('stats-end-date');
    // NEW: è®¤è¯å’Œåº”ç”¨ç•Œé¢ DOM
    const appLoadingDiv = document.getElementById('app-loading');
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.querySelector('.app-container');
    const authMessage = document.getElementById('auth-message');


    // NEW: è®¤è¯å¤„ç†å‡½æ•°
    const handleAuth = async () => {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (session) {
            currentUser = session.user;
            authContainer.style.display = 'none';
            appLoadingDiv.style.display = 'none';
            appContainer.style.display = 'flex'; // æ˜¾ç¤ºä¸»åº”ç”¨
            document.getElementById('user-email').textContent = currentUser.email;
            await initializeApp(); // åˆå§‹åŒ–åº”ç”¨æ•°æ®
        } else {
            appLoadingDiv.style.display = 'none';
            authContainer.style.display = 'block'; // æ˜¾ç¤ºç™»å½•æ¡†
        }
    };
    
    // NEW: åº”ç”¨åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨ç”¨æˆ·ç™»å½•åè°ƒç”¨
    async function initializeApp() {
        await loadData(); // ä» Supabase åŠ è½½æ•°æ®
        setupEventListeners();
        populateSelect(document.getElementById('task-urgency'), Object.keys(URGENCY_LEVELS));
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('task-start-date').valueAsDate = today;
        document.getElementById('task-end-date').valueAsDate = today;
        statsStartDateInput.valueAsDate = firstDayOfMonth;
        statsEndDateInput.valueAsDate = today;
        render();
    }
    
    // --- æ•°æ®æŒä¹…åŒ– (å·²é‡å†™ä¸º Supabase) ---
    async function loadData() {
        if (!currentUser) return;
        try {
            // åŠ è½½ä»»åŠ¡
            const { data: taskData, error: taskError } = await supabase
                .from('tasks')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });
            if (taskError) throw taskError;
            tasks = taskData || [];
            
            // åŠ è½½å‘¨æŠ¥
            const { data: progressData, error: progressError } = await supabase
                .from('weekly_progress')
                .select('*')
                .eq('user_id', currentUser.id);
            if (progressError) throw progressError;
            weeklyProgress = (progressData || []).reduce((acc, item) => {
                acc[item.week_id] = item;
                return acc;
            }, {});
            
            // ç¡®ä¿æœ¬åœ°æ•°æ®ç»“æ„å…¼å®¹
            tasks.forEach(task => {
                task.daily_progress = task.daily_progress || {};
            });

        } catch (error) {
            console.error('Error loading data:', error);
            alert('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
        }
    }
    
    // NEW: ä¸å†éœ€è¦ saveData()ï¼Œæ¯ä¸ªæ“ä½œéƒ½ä¼šç›´æ¥ä¸æ•°æ®åº“äº¤äº’
    
    // --- æ¸²æŸ“ä¸»å‡½æ•° ---
    function render() {
        renderTaskList();
        updateStats();
        updateUrgentTasks();
        populateWeekSelector();
        loadSelectedWeekData();
    }
    
    // --- æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ (åŸºæœ¬ä¸å˜) ---
    function renderTaskList() {
        taskListBody.innerHTML = '';
        const filteredAndSortedTasks = getFilteredAndSortedTasks();
        if (filteredAndSortedTasks.length === 0) {
            taskListBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--color-text-secondary);">æ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡...</td></tr>`;
            return;
        }

        const fragment = document.createDocumentFragment();
        filteredAndSortedTasks.forEach((task, index) => {
            const tr = document.createElement('tr');
            tr.dataset.taskId = task.id;
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><div class="task-name">${escapeHtml(task.name)}</div></td>
                <td><div style="font-size: 0.9rem;">${task.start_date}<br><span style="color:var(--color-text-secondary); font-size:0.8rem;">åˆ° ${task.end_date}</span></div></td>
                <td><select class="inline-edit" data-task-id="${task.id}" data-type="urgency"></select></td>
                <td><select class="inline-edit" data-task-id="${task.id}" data-type="status"></select></td>
                <td class="task-actions"><button title="ç¼–è¾‘/æŸ¥çœ‹è¯¦æƒ…">âœï¸</button><button title="åˆ é™¤ä»»åŠ¡">ğŸ—‘ï¸</button></td>
            `;
            
            const applySelectStyles = (select, type) => {
                const badgeClass = type === 'urgency' ? `urgency-${URGENCY_LEVELS[select.value]?.value || 1}` : select.value.replace(/\s+/g, '');
                select.className = `inline-edit badge ${type}-badge ${badgeClass}`;
            };
            
            const urgencySelect = tr.querySelector('[data-type="urgency"]');
            const statusSelect = tr.querySelector('[data-type="status"]');
            
            populateSelect(urgencySelect, Object.keys(URGENCY_LEVELS), task.urgency);
            populateSelect(statusSelect, STATUS_OPTIONS, task.status);
            
            urgencySelect.addEventListener('change', async (e) => { 
                await updateTask(e.target.dataset.taskId, { urgency: e.target.value });
                applySelectStyles(e.target, 'urgency');
            });
            statusSelect.addEventListener('change', async (e) => {
                await updateTask(e.target.dataset.taskId, { status: e.target.value });
                applySelectStyles(e.target, 'status');
            });
            
            applySelectStyles(urgencySelect, 'urgency');
            applySelectStyles(statusSelect, 'status');
            fragment.appendChild(tr);
        });
        taskListBody.appendChild(fragment);
    }
    
    // --- ç»Ÿè®¡å’Œç´§æ€¥ä»»åŠ¡å‡½æ•° (åŸºæœ¬ä¸å˜) ---
    function updateStats() { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function updateUrgentTasks() { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }

    // --- äº‹ä»¶ç›‘å¬ ---
    function setupEventListeners() {
        document.getElementById('add-task-form').addEventListener('submit', addTask);
        searchBox.addEventListener('input', (e) => { currentFilter = e.target.value; renderTaskList(); });
        document.getElementById('sort-urgency').addEventListener('click', () => setSort('urgency'));
        document.getElementById('sort-status').addEventListener('click', () => setSort('status'));
        document.getElementById('clear-filter').addEventListener('click', () => { searchBox.value = ''; currentFilter = ''; currentSort = { key: 'created_at', reverse: true }; updateSortButtons(); renderTaskList(); });
        statsStartDateInput.addEventListener('change', updateStats);
        statsEndDateInput.addEventListener('change', updateStats);

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelector('.tab-button.active')?.classList.remove('active');
                document.querySelector('.tab-pane.active')?.classList.remove('active');
                e.currentTarget.classList.add('active');
                document.getElementById(`tab-${e.currentTarget.dataset.tab}`).classList.add('active');
            });
        });

        taskListBody.addEventListener('click', e => {
            const targetButton = e.target.closest('button');
            if (!targetButton) return;
            const tr = e.target.closest('tr');
            if(!tr) return;
            const taskId = tr.dataset.taskId;
            if (targetButton.title.includes('åˆ é™¤')) deleteTask(taskId);
            if (targetButton.title.includes('ç¼–è¾‘')) openEditModal(taskId);
        });

        document.getElementById('week-selector').addEventListener('change', loadSelectedWeekData);
        document.getElementById('generate-report-btn').addEventListener('click', generateWeeklyReport);
        document.getElementById('save-report-btn').addEventListener('click', saveWeeklyReport);
        document.getElementById('backup-data').addEventListener('click', backupData);
        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.currentTarget.dataset.target)));
        
        setupBatchModalListeners();
        setupEditModalListeners();
        
        // NEW: ç™»å‡ºæŒ‰é’®
        document.getElementById('logout-btn').addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                alert('ç™»å‡ºå¤±è´¥: ' + error.message);
            } else {
                currentUser = null;
                tasks = [];
                weeklyProgress = {};
                appContainer.style.display = 'none';
                authContainer.style.display = 'block';
                 window.location.reload(); // é‡æ–°åŠ è½½é¡µé¢ä»¥ç¡®ä¿çŠ¶æ€å¹²å‡€
            }
        });
    }
    
    function setupBatchModalListeners() { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function setupEditModalListeners() { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }

    // NEW: é‡å†™æ ¸å¿ƒæ•°æ®æ“ä½œå‡½æ•°
    async function addTask(e) {
        e.preventDefault();
        const form = e.target;
        const name = form.querySelector('#task-name').value.trim();
        const start_date = form.querySelector('#task-start-date').value;
        const end_date = form.querySelector('#task-end-date').value;
        const urgency = form.querySelector('#task-urgency').value;
        if (!name || !start_date || !end_date || !urgency) { alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼'); return; }
        if (new Date(end_date) < new Date(start_date)) { alert('ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸï¼'); return; }
        
        const newTask = {
            name,
            start_date,
            end_date,
            urgency,
            user_id: currentUser.id,
            status: 'å¾…åŠ',
            notes: '',
            daily_progress: {}
        };

        try {
            const { data, error } = await supabase.from('tasks').insert(newTask).select().single();
            if (error) throw error;
            tasks.unshift(data); // æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
            render(); // é‡æ–°æ¸²æŸ“
            form.reset();
            form.querySelector('#task-start-date').valueAsDate = new Date();
            form.querySelector('#task-end-date').valueAsDate = new Date();
        } catch (error) {
            console.error('Error adding task:', error);
            alert('æ·»åŠ ä»»åŠ¡å¤±è´¥: ' + error.message);
        }
    }

    function getFilteredAndSortedTasks() { /* ... æ­¤å‡½æ•°é€»è¾‘åŸºæœ¬ä¸å˜ï¼Œä½†æ’åºkeyå¯èƒ½éœ€è¦è°ƒæ•´ ... */
        let result = [...tasks];
        if (currentFilter) {
            const searchTerm = currentFilter.toLowerCase();
            result = result.filter(task => Object.values(task).some(val => String(val).toLowerCase().includes(searchTerm)));
        }
        const { key, reverse } = currentSort;
        result.sort((a, b) => {
            let valA, valB;
            switch(key) {
                case 'urgency': valA = URGENCY_LEVELS[a.urgency]?.value || 0; valB = URGENCY_LEVELS[b.urgency]?.value || 0; break;
                case 'status': valA = STATUS_OPTIONS.indexOf(a.status); valB = STATUS_OPTIONS.indexOf(b.status); break;
                default: valA = new Date(a.created_at); valB = new Date(b.created_at); break; // æŒ‰æ—¥æœŸæ’åº
            }
            if (valA < valB) return reverse ? 1 : -1;
            if (valA > valB) return reverse ? -1 : 1;
            return 0;
        });
        return result;
    }
    
    function setSort(key) { if (currentSort.key === key) { currentSort.reverse = !currentSort.reverse; } else { currentSort.key = key; currentSort.reverse = (key === 'urgency' || key === 'created_at'); } updateSortButtons(); renderTaskList(); }
    
    function updateSortButtons() { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    
    async function updateTask(id, updates) {
        try {
            const { data, error } = await supabase
                .from('tasks')
                .update(updates)
                .eq('id', id)
                .select()
                .single();
            
            if (error) throw error;
            
            // æ›´æ–°æœ¬åœ°æ•°ç»„ä¸­çš„ä»»åŠ¡
            const index = tasks.findIndex(t => t.id === id);
            if (index !== -1) {
                tasks[index] = { ...tasks[index], ...data };
            }
            // é‡æ–°æ¸²æŸ“ä»¥åæ˜ æ‰€æœ‰å˜åŒ–ï¼ˆå¦‚ç»Ÿè®¡æ•°æ®ï¼‰
            render();
        } catch (error) {
            console.error('Error updating task:', error);
            alert('æ›´æ–°ä»»åŠ¡å¤±è´¥: ' + error.message);
        }
    }

    async function deleteTask(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼')) {
            try {
                const { error } = await supabase.from('tasks').delete().eq('id', id);
                if (error) throw error;
                
                tasks = tasks.filter(t => t.id !== id);
                render();
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('åˆ é™¤ä»»åŠ¡å¤±è´¥: ' + error.message);
            }
        }
    }
    
    function populateSelect(select, options, selectedValue = null) { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function escapeHtml(str) { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function openModal(id) { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function closeModal(id) { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    
    // --- å‘¨æŠ¥ç›¸å…³å‡½æ•° (saveWeeklyReport ä¿®æ”¹) ---
    function getWeekIdFromDate(d) { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function getWeekStartEndDates(weekId) { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function formatDate(date, full = false) { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function populateWeekSelector() { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function loadSelectedWeekData() { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function generateWeeklyReport() { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    
    async function saveWeeklyReport() {
        const selectedWeekId = document.getElementById('week-selector').value;
        if (!selectedWeekId) return;
        
        const reportData = {
            user_id: currentUser.id,
            week_id: selectedWeekId,
            generated_report: document.getElementById('generated-report-area').value
        };

        try {
            // upsert = update or insert. å¦‚æœè®°å½•å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥
            const { data, error } = await supabase.from('weekly_progress').upsert(reportData).select().single();
            if (error) throw error;
            
            weeklyProgress[selectedWeekId] = data; // æ›´æ–°æœ¬åœ°ç¼“å­˜
            alert('å‘¨æŠ¥å·²ä¿å­˜åˆ°äº‘ç«¯ï¼');
        } catch (error) {
            console.error('Error saving weekly report:', error);
            alert('ä¿å­˜å‘¨æŠ¥å¤±è´¥: ' + error.message);
        }
    }
    
    // --- å…¶ä»–æ“ä½œå‡½æ•° (éƒ¨åˆ†ä¿®æ”¹) ---
    function backupData() { /* ... æ­¤å‡½æ•°é€»è¾‘ä¸å˜, ä¾ç„¶æ˜¯æœ¬åœ°å¤‡ä»½ */ }
    
    async function saveManualBatch() {
        const container = document.getElementById('batch-tasks-container');
        const rows = container.querySelectorAll('div');
        const newTasks = [];

        rows.forEach(row => {
            const name = row.querySelector('.batch-name').value.trim();
            const start_date = row.querySelector('.batch-start-date').value;
            const end_date = row.querySelector('.batch-end-date').value;
            const urgency = row.querySelector('.batch-urgency').value;
            if(name && start_date && end_date && urgency) {
                newTasks.push({
                    name, start_date, end_date, urgency,
                    user_id: currentUser.id,
                    status: 'å¾…åŠ', notes: '', daily_progress: {}
                });
            }
        });
        
        if (newTasks.length > 0) {
            try {
                const { data, error } = await supabase.from('tasks').insert(newTasks).select();
                if (error) throw error;

                tasks.unshift(...data); // å°†æ‰€æœ‰æ–°ä»»åŠ¡æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
                render();
                alert(`æˆåŠŸæ·»åŠ  ${data.length} ä¸ªä»»åŠ¡ï¼`);
                closeModal('batch-modal');
            } catch (error) {
                 console.error('Error batch adding tasks:', error);
                 alert('æ‰¹é‡æ·»åŠ ä»»åŠ¡å¤±è´¥: ' + error.message);
            }
        } else {
            alert('æ²¡æœ‰è¾“å…¥ä»»ä½•æœ‰æ•ˆçš„ä»»åŠ¡ã€‚');
        }
    }
    
    function openEditModal(taskId) { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    function renderDailyProgressEditor(task) { /* ... æ­¤å‡½æ•°æ— éœ€ä¿®æ”¹ ... */ }
    
    async function saveEditTask() {
        const id = document.getElementById('edit-task-id').value;
        const updates = {
            name: document.getElementById('edit-task-name').value,
            start_date: document.getElementById('edit-task-start-date').value,
            end_date: document.getElementById('edit-task-end-date').value,
            urgency: document.getElementById('edit-task-urgency').value,
            status: document.getElementById('edit-task-status').value,
            notes: document.getElementById('edit-task-notes').value
        };
        await updateTask(id, updates);
        closeModal('edit-modal');
    }
    
    async function addDailyProgress() {
        const id = document.getElementById('edit-task-id').value;
        const task = tasks.find(t => t.id === id);
        const contentInput = document.getElementById('new-progress-content');
        const content = contentInput.value.trim();
        if (!task || !content) return;
        
        const todayStr = new Date().toISOString().split('T')[0];
        if (!task.daily_progress[todayStr]) {
            task.daily_progress[todayStr] = [];
        }
        task.daily_progress[todayStr].push({ content, timestamp: new Date().toISOString() });
        
        await updateTask(id, { daily_progress: task.daily_progress });
        contentInput.value = '';
        renderDailyProgressEditor(task); // æœ¬åœ°ç«‹å³æ›´æ–°UI
    }

    async function deleteDailyProgress(taskId, date, index) {
        const task = tasks.find(t => t.id === taskId);
        if (task && task.daily_progress[date]) {
            task.daily_progress[date].splice(index, 1);
            if (task.daily_progress[date].length === 0) {
                delete task.daily_progress[date];
            }
            await updateTask(taskId, { daily_progress: task.daily_progress });
            renderDailyProgressEditor(task); // æœ¬åœ°ç«‹å³æ›´æ–°UI
        }
    }
    
    // NEW: è®¤è¯ç›¸å…³äº‹ä»¶ç›‘å¬
    document.getElementById('auth-toggle').addEventListener('click', () => {
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const toggleButton = document.getElementById('auth-toggle');
        
        if (loginForm.style.display !== 'none') {
            loginForm.style.display = 'none';
            signupForm.style.display = 'flex';
            toggleButton.textContent = 'å·²æœ‰è´¦æˆ·ï¼Ÿç‚¹æ­¤ç™»å½•';
        } else {
            loginForm.style.display = 'flex';
            signupForm.style.display = 'none';
            toggleButton.textContent = 'è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿç‚¹æ­¤æ³¨å†Œ';
        }
        authMessage.textContent = '';
    });

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            authMessage.textContent = 'ç™»å½•å¤±è´¥: ' + error.message;
        } else {
            authMessage.textContent = '';
            handleAuth(); // ç™»å½•æˆåŠŸï¼Œé‡æ–°æ£€æŸ¥å¹¶åŠ è½½åº”ç”¨
        }
    });

    document.getElementById('signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const { error } = await supabase.auth.signUp({ email, password });
        if (error) {
            authMessage.textContent = 'æ³¨å†Œå¤±è´¥: ' + error.message;
        } else {
            authMessage.textContent = 'æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±ä»¥å®ŒæˆéªŒè¯ï¼Œç„¶åç™»å½•ã€‚';
            // åˆ‡æ¢å›ç™»å½•è§†å›¾
            document.getElementById('login-form').style.display = 'flex';
            document.getElementById('signup-form').style.display = 'none';
            document.getElementById('auth-toggle').textContent = 'è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿç‚¹æ­¤æ³¨å†Œ';
        }
    });

    // --- åº”ç”¨å¯åŠ¨ ---
    handleAuth(); // é¡µé¢åŠ è½½æ—¶ç«‹å³æ£€æŸ¥è®¤è¯çŠ¶æ€
});
</script>

</body>
</html>